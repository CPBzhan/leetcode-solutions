#!/usr/bin/env python3
import sys
import os
import datetime
import re

# -------------------------------
# Utility functions
# -------------------------------

def to_url(name):
    """Convert 'Trapping-Rain-Water' -> 'trapping-rain-water'"""
    return name.lower().replace(" ", "-").replace("_", "-")

def ensure_folder(path):
    if not os.path.exists(path):
        os.makedirs(path)

def read_readme():
    if not os.path.exists("README.md"):
        return ""
    with open("README.md", "r", encoding="utf8") as f:
        return f.read()

def write_readme(content):
    with open("README.md", "w", encoding="utf8") as f:
        f.write(content)

# -------------------------------
# Main Script
# -------------------------------

if len(sys.argv) != 5:
    print("Usage: ./add <id> \"<name>\" <lang> <difficulty>")
    sys.exit(1)

qid = sys.argv[1]
name = sys.argv[2]
lang = sys.argv[3].lower()   # cpp or python
diff = sys.argv[4].lower()   # easy/medium/hard

# Validate
if lang not in ["cpp", "python"]:
    print("Language must be cpp or python")
    sys.exit(1)

if diff not in ["easy", "medium", "hard"]:
    print("Difficulty must be easy/medium/hard")
    sys.exit(1)

# -------------------------------
# Prepare paths and names
# -------------------------------
folder_name = f"{qid}-{name}"
folder_path = f"src/{folder_name}"

ensure_folder(folder_path)

# Generate solution filename
ext = "cpp" if lang == "cpp" else "py"
solution_file = f"{qid}.{ext}"
solution_path = f"{folder_path}/{solution_file}"

if not os.path.exists(solution_path):
    with open(solution_path, "w", encoding="utf8") as f:
        f.write("// Solution\n" if lang == "cpp" else "# Solution\n")

# Create README if missing
if not os.path.exists("README.md"):
    write_readme("# LeetCode Solutions\n\n## ðŸ“š Problem List\n\n| ID | Problem | Difficulty | Languages | Last Update |\n|----|---------|------------|-----------|-------------|\n")

# -------------------------------
# Update README.md
# -------------------------------

readme = read_readme()

# Extract table
pattern = r"(\| ID \|[\s\S]*?\|-------------\|)([\s\S]*)"
match = re.search(pattern, readme)

if not match:
    print("README.md format error: Cannot find Problem List table.")
    sys.exit(1)

table_header = match.group(1)
table_body = match.group(2).strip()

# Create new row
today = datetime.date.today().strftime("%Y-%m-%d")
url = f"https://leetcode.com/problems/{to_url(name)}/"
sol_link = f"[{ext.upper()}](./src/{folder_name}/{solution_file})"

new_row = f"| {qid} | {name.replace('-', ' ')} | {diff.capitalize()} | {sol_link} | {today} |"

# Parse table rows
rows = []
if table_body:
    for line in table_body.split("\n"):
        line = line.strip()
        if line.startswith("|"):
            rows.append(line)

# Add or replace existing row
rows = [row for row in rows if not row.startswith(f"| {qid} ")]
rows.append(new_row)

# Sort by ID
def extract_id(row):
    return int(row.split("|")[1].strip())

rows = sorted(rows, key=extract_id)

# Rebuild table
new_table = table_header + "\n" + "\n".join(rows) + "\n"

# Replace entire table
new_readme = re.sub(pattern, new_table, readme)

write_readme(new_readme)

print(f"Added/updated problem {qid}: {name} ({lang}, {diff})")
print(f"Folder: {folder_path}")
print(f"Solution file: {solution_path}")
